<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3조 소과제: Harbor | HTDP1</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="htdp1 github pages">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/am-arch/assets/css/0.styles.cf1d3b34.css" as="style"><link rel="preload" href="/am-arch/assets/js/app.1912b913.js" as="script"><link rel="preload" href="/am-arch/assets/js/2.24fdfc9c.js" as="script"><link rel="preload" href="/am-arch/assets/js/3.0b98036c.js" as="script"><link rel="prefetch" href="/am-arch/assets/js/10.f985dceb.js"><link rel="prefetch" href="/am-arch/assets/js/11.13a0885b.js"><link rel="prefetch" href="/am-arch/assets/js/12.784f5764.js"><link rel="prefetch" href="/am-arch/assets/js/13.0705463a.js"><link rel="prefetch" href="/am-arch/assets/js/14.edf1e9bf.js"><link rel="prefetch" href="/am-arch/assets/js/15.ecbe92b4.js"><link rel="prefetch" href="/am-arch/assets/js/16.b0e5273b.js"><link rel="prefetch" href="/am-arch/assets/js/17.c1412e8f.js"><link rel="prefetch" href="/am-arch/assets/js/18.2bf38a43.js"><link rel="prefetch" href="/am-arch/assets/js/19.d66be9cb.js"><link rel="prefetch" href="/am-arch/assets/js/20.2d12a517.js"><link rel="prefetch" href="/am-arch/assets/js/21.4a5538a4.js"><link rel="prefetch" href="/am-arch/assets/js/22.1bb76293.js"><link rel="prefetch" href="/am-arch/assets/js/23.5000784d.js"><link rel="prefetch" href="/am-arch/assets/js/24.54dfc05b.js"><link rel="prefetch" href="/am-arch/assets/js/25.7a3200a9.js"><link rel="prefetch" href="/am-arch/assets/js/26.5cb3a254.js"><link rel="prefetch" href="/am-arch/assets/js/27.0c63f9e7.js"><link rel="prefetch" href="/am-arch/assets/js/28.58281d66.js"><link rel="prefetch" href="/am-arch/assets/js/29.164199d9.js"><link rel="prefetch" href="/am-arch/assets/js/30.495713a6.js"><link rel="prefetch" href="/am-arch/assets/js/31.4507fc8d.js"><link rel="prefetch" href="/am-arch/assets/js/32.e2d5f511.js"><link rel="prefetch" href="/am-arch/assets/js/33.5a7d28a0.js"><link rel="prefetch" href="/am-arch/assets/js/34.24927452.js"><link rel="prefetch" href="/am-arch/assets/js/35.b946ec72.js"><link rel="prefetch" href="/am-arch/assets/js/36.643ccf86.js"><link rel="prefetch" href="/am-arch/assets/js/37.baf5ac72.js"><link rel="prefetch" href="/am-arch/assets/js/38.924d0d58.js"><link rel="prefetch" href="/am-arch/assets/js/39.c9ada2db.js"><link rel="prefetch" href="/am-arch/assets/js/4.3bf6929e.js"><link rel="prefetch" href="/am-arch/assets/js/40.59ff4950.js"><link rel="prefetch" href="/am-arch/assets/js/41.e36e5e29.js"><link rel="prefetch" href="/am-arch/assets/js/42.8fbd702b.js"><link rel="prefetch" href="/am-arch/assets/js/43.682ed0be.js"><link rel="prefetch" href="/am-arch/assets/js/44.e96bd250.js"><link rel="prefetch" href="/am-arch/assets/js/45.e5548ca0.js"><link rel="prefetch" href="/am-arch/assets/js/46.eb3135d2.js"><link rel="prefetch" href="/am-arch/assets/js/47.75bfb6d8.js"><link rel="prefetch" href="/am-arch/assets/js/48.24475551.js"><link rel="prefetch" href="/am-arch/assets/js/49.4f9d97da.js"><link rel="prefetch" href="/am-arch/assets/js/5.612537aa.js"><link rel="prefetch" href="/am-arch/assets/js/50.9396ae6a.js"><link rel="prefetch" href="/am-arch/assets/js/51.0246b6e3.js"><link rel="prefetch" href="/am-arch/assets/js/52.b63d5ce3.js"><link rel="prefetch" href="/am-arch/assets/js/53.1f0c3f8c.js"><link rel="prefetch" href="/am-arch/assets/js/54.945e81a6.js"><link rel="prefetch" href="/am-arch/assets/js/55.7f8cfc43.js"><link rel="prefetch" href="/am-arch/assets/js/56.c5892f1b.js"><link rel="prefetch" href="/am-arch/assets/js/57.95dda11c.js"><link rel="prefetch" href="/am-arch/assets/js/58.5239fcca.js"><link rel="prefetch" href="/am-arch/assets/js/59.8c2edf4b.js"><link rel="prefetch" href="/am-arch/assets/js/6.744bf98a.js"><link rel="prefetch" href="/am-arch/assets/js/60.41a76796.js"><link rel="prefetch" href="/am-arch/assets/js/61.1397672a.js"><link rel="prefetch" href="/am-arch/assets/js/62.f17e7ccd.js"><link rel="prefetch" href="/am-arch/assets/js/63.26013c6d.js"><link rel="prefetch" href="/am-arch/assets/js/64.5a311c5f.js"><link rel="prefetch" href="/am-arch/assets/js/65.eb28022b.js"><link rel="prefetch" href="/am-arch/assets/js/7.fed2825e.js"><link rel="prefetch" href="/am-arch/assets/js/8.8c182984.js"><link rel="prefetch" href="/am-arch/assets/js/9.3fd7e149.js">
    <link rel="stylesheet" href="/am-arch/assets/css/0.styles.cf1d3b34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/am-arch/" class="home-link router-link-active"><!----> <span class="site-name">HTDP1</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/am-arch/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/am-arch/cloud/" class="nav-link">
  Cloud
</a></div><div class="nav-item"><a href="/am-arch/refarch/" class="nav-link router-link-active">
  Ref. Arch.
</a></div><div class="nav-item"><a href="/am-arch/cloud-native-app/" class="nav-link">
  Cloud.Native.App
</a></div><div class="nav-item"><a href="/am-arch/machinelearning/" class="nav-link">
  M / L
</a></div><div class="nav-item"><a href="/am-arch/gitops/" class="nav-link">
  GitOps
</a></div><div class="nav-item"><a href="/am-arch/multi-cloud/" class="nav-link">
  Multi Cloud
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/am-arch/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/am-arch/cloud/" class="nav-link">
  Cloud
</a></div><div class="nav-item"><a href="/am-arch/refarch/" class="nav-link router-link-active">
  Ref. Arch.
</a></div><div class="nav-item"><a href="/am-arch/cloud-native-app/" class="nav-link">
  Cloud.Native.App
</a></div><div class="nav-item"><a href="/am-arch/machinelearning/" class="nav-link">
  M / L
</a></div><div class="nav-item"><a href="/am-arch/gitops/" class="nav-link">
  GitOps
</a></div><div class="nav-item"><a href="/am-arch/multi-cloud/" class="nav-link">
  Multi Cloud
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Introduction</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/refarch/" aria-current="page" class="sidebar-link">Overview</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/refarch/" aria-current="page" class="sidebar-link">Overview</a></li><li><a href="/am-arch/refarch/perftest.html" class="sidebar-link">Redis 성능 측정</a></li><li><a href="/am-arch/refarch/hatest.html" class="sidebar-link">Redis HA with standalone</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>EIP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/refarch/camel.html" class="sidebar-link">Apache Camel and EIP</a></li><li><a href="/am-arch/refarch/legacy.html" class="sidebar-link">Legacy Interface 개발</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>KeyCloak</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/refarch/keycloak.html" class="sidebar-link">2조 소과제: Keycloak</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Harbor</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/am-arch/refarch/harbor.html" aria-current="page" class="active sidebar-link">3조 소과제: Harbor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#why-harbor" class="sidebar-link">Why Harbor?</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#_1-harbor란" class="sidebar-link">1. Harbor란?</a></li><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#_2-why-harbor" class="sidebar-link">2. Why Harbor?</a></li><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#_3-our-harbor-architecture" class="sidebar-link">3. Our Harbor Architecture</a></li></ul></li><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#practice" class="sidebar-link">Practice</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#_1-https-수신-컨트롤러-구성" class="sidebar-link">1. HTTPS 수신 컨트롤러 구성</a></li><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#_2-harbor-설치" class="sidebar-link">2. Harbor 설치</a></li><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#_3-keyclock-oidc-연동-및-권한제어" class="sidebar-link">3. keyclock OIDC 연동 및 권한제어</a></li><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#_4-registry-replication" class="sidebar-link">4. Registry Replication</a></li><li class="sidebar-sub-header"><a href="/am-arch/refarch/harbor.html#_5-vulnerability-scanning" class="sidebar-link">5. Vulnerability Scanning</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_3조-소과제-harbor"><a href="#_3조-소과제-harbor" class="header-anchor">#</a> 3조 소과제: Harbor</h1> <h2 id="why-harbor"><a href="#why-harbor" class="header-anchor">#</a> Why Harbor?</h2> <h3 id="_1-harbor란"><a href="#_1-harbor란" class="header-anchor">#</a> 1. Harbor란?</h3> <h4 id="_1-harbor"><a href="#_1-harbor" class="header-anchor">#</a> 1. Harbor?</h4> <p><img src="/am-arch/assets/img/harbor-whatisharbor.eeb68fe9.png" alt="What is harbor?"><br>
(출처 : https://goharbor.io/)</p> <p>Harbor는 정책 및 역할 기반 액세스 제어로 artifact를 보호하고, 이미지가 스캔되고 취약성이 없는지 확인하고, 이미지를 신뢰할 수 있는 것으로 서명하는 오픈 소스 레지스트리입니다. CNCF(Cloud Native Computing Foundation) 재단 Graduated 프로젝트인 Harbor는 규정 준수, 성능 및 상호 운용성을 제공하여 Kubernetes 및 Docker와 같은 클라우드 네이티브 컴퓨팅 플랫폼에서 일관되고 안전하게 artifact를 관리하는 데 도움이 됩니다.</p> <p><img src="/am-arch/assets/img/harbor-maturitylevels.339ef550.png" alt="CNCF 프로젝트 성숙도 기준"><br>
(CNCF 프로젝트 성숙도 기준, 출처: https://www.cncf.io/projects/)</p> <img src="/am-arch/assets/img/harbor-container.9905ce0c.png" width="70%" height="70%"> <p>(출처: https://landscape.cncf.io/?category=container-registry&amp;grouping=category)</p> <h4 id="_2-architecture-overview"><a href="#_2-architecture-overview" class="header-anchor">#</a> 2. Architecture Overview</h4> <p><img src="/am-arch/assets/img/harbor-archi.b3fa36eb.png" alt="Harbor Architecture"><br>
(출처: https://github.com/goharbor/harbor/wiki/Arch%E3%85%81itecture-Overview-of-Harbor)</p> <h4 id="_3-main-feature"><a href="#_3-main-feature" class="header-anchor">#</a> 3. Main Feature</h4> <p><img src="/am-arch/assets/img/harbor-mainfeature.bd32d2ad.png" alt="Harbor Mainfeature"><br>
(출처: https://goharbor.io/)</p> <ul><li>Security and vulnerability analysis
<ul><li>Harbor는 이미지를 정기적으로 스캔하여 취약성을 확인하고 취약한 이미지가 배포되는 것을 방지하기 위한 정책 검사를 수행한다.</li></ul></li> <li>Content signing and validation</li> <li>Multi-tenant</li> <li>Extensible API and web UI</li> <li>Image replication across multiple Harbor instances
<ul><li>filter(repository, tag, label)를 사용하는 정책을 기반으로 여러 레지스트리 인스턴스 간에 이미지와 차트를 복제(동기화)할 수 있다. Harbor는 오류가 발생하면 자동으로 복제를 재시도한다. 이는 로드 밸런싱을 지원하고 고가용성을 달성하며 하이브리드 및 다중 클라우드 시나리오에서 다중 데이터 센터 배포를 촉진하는 데 사용할 수 있다.</li></ul></li> <li>Identity integration and role-based access control(RBAC) : 프로젝트별로 유저의 권한을 따로 부여할 수 있고, 그 권한에 따라 액션이 제한된다.</li></ul> <p><img src="/am-arch/assets/img/harbor-rbac.f1106852.png" alt="Harbor RBAC"><br>
(출처: https://github.com/goharbor/harbor/blob/master/docs/user_guide.md#role-based-access-controlrbac)</p> <h3 id="_2-why-harbor"><a href="#_2-why-harbor" class="header-anchor">#</a> 2. Why Harbor?</h3> <h4 id="_1-public-vs-private"><a href="#_1-public-vs-private" class="header-anchor">#</a> 1. public vs. private</h4> <p>컨테이너 레지스트리에는 public 및 private의 두 가지 유형이 있습니다.</p> <p>- <strong>public registry</strong>는 abilities/offerings 측면에서 기본적이며 사용하기 쉽고, 가능한 한 빨리 registry를 시작하고 실행하려는 개인 또는 소규모 팀에 적합합니다. 그러나 규모가 성장함에 따라 패치, 개인 정보 보호 및 액세스 제어와 같은 보안 문제가 발생할 수 있습니다.</p> <p>- <strong>pirvate registry</strong>는 원격으로 호스팅되거나 온프레미스에서 호스팅되는 엔터프라이즈 컨테이너 이미지 스토리지에 보안 및 개인 정보를 통합하는 방법을 제공합니다. 회사는 자체 컨테이너 registry를 만들고 배포하도록 선택하거나 상업적 private registry 서비스를 선택할 수 있습니다. 이러한 private registry에는 고급 보안 기능과 기술 지원이 함께 제공되는 경우가 많습니다.</p> <h4 id="_2-nexus-vs-harbor"><a href="#_2-nexus-vs-harbor" class="header-anchor">#</a> 2. nexus vs. harbor</h4> <table data-ke-align="alignLeft" data-ke-style="style12" style="border-collapse:collapse;width:100%;"><tbody><tr style="height:18px;"><td style="width:17.0542%;height:18px;text-align:center;"> </td><td style="width:44.1473%;height:18px;text-align:center;"><b>nexus</b></td><td style="width:38.7984%;height:18px;text-align:center;"><b>harbor</b></td></tr><tr style="height:18px;"><td style="width:17.0542%;height:18px;text-align:center;"><b>docker</b></td><td style="width:44.1473%;height:18px;"><span style="color:#000000;"><span> </span>Docker Registry가 주된 기능이 아닌 통합 Repository 개념</span></td><td style="width:38.7984%;height:18px;"><span style="color:#000000;">Docker Registry이외에 Garbage Collection, Docker Image 취약점 점검 등의 부가 기능을 추가로 제공</span></td></tr><tr style="height:18px;"><td style="width:17.0542%;height:18px;text-align:center;"><b>Active/Active HA</b></td><td style="width:44.1473%;height:18px;">Nexus Repository Pro에 한해 HA-C 지원<br>(Starts at 3,000$/year)</td><td style="width:38.7984%;height:18px;">Replication으로 Registry 간의 이미지 동기화 지원</td></tr></tbody></table> <p><img src="/am-arch/assets/img/harbor-nexus.b9da7710.png" alt="Nexus"><br>
(출처: https://help.sonatype.com/repomanager3/high-availability)</p> <h4 id="_3-harbor"><a href="#_3-harbor" class="header-anchor">#</a> 3. Harbor?</h4> <table data-ke-align="alignLeft" data-ke-style="style12" style="border-collapse:collapse;width:100%;"><tbody><tr style="height:18px;"><td style="width:33.3333%;text-align:center;height:18px;">pros</td><td style="width:33.3333%;text-align:center;height:18px;">cons</td></tr><tr style="height:18px;"><td style="width:33.3333%;height:18px;">identity management</td><td rowspan="5" style="width:33.3333%;height:90px;"><h3 data-ke-size="size23"><span style="font-size:15px;color:#333333;font-family:-apple-system, BlinkMacSystemFont, AppleSDGothicNeo-Regular, 'Malgun Gothic', '맑은 고딕', dotum, 돋움, sans-serif;letter-spacing:0px;">hard to setup on k8s cluster</span></h3></td></tr><tr style="height:18px;"><td style="width:33.3333%;height:18px;">API and graphical UI</td></tr><tr style="height:18px;"><td style="width:33.3333%;height:18px;"><span style="color:#151515;">Vulnerability scanning</span></td></tr><tr style="height:18px;"><td style="width:33.3333%;height:18px;">image replication</td></tr><tr style="height:18px;"><td style="width:33.3333%;height:18px;">online or offline installation</td></tr></tbody></table>
(출처: https://www.slant.co/topics/2436/~best-docker-image-private-registries)
<h3 id="_3-our-harbor-architecture"><a href="#_3-our-harbor-architecture" class="header-anchor">#</a> 3. Our Harbor Architecture</h3> <p><img src="/am-arch/assets/img/harbor-dp3archi.b17b0649.png" alt="DP3 Harbor Archi."></p> <h2 id="practice"><a href="#practice" class="header-anchor">#</a> Practice</h2> <h3 id="_1-https-수신-컨트롤러-구성"><a href="#_1-https-수신-컨트롤러-구성" class="header-anchor">#</a> 1. HTTPS 수신 컨트롤러 구성</h3> <p>Harbor는 선택적으로 HTTP 연결을 지원하지만 Docker Client는 항상 먼저 HTTPS를 사용하여 레지스트리에 연결을 시도한다.</p> <p><img src="/am-arch/assets/img/harbor-https.1f8f7a66.png" alt="HTTPS"><br>
(출처: https://goharbor.io/docs/1.10/working-with-projects/working-with-images/pulling-pushing-images/)</p> <h4 id="_1-eks에-https-수신-컨트롤러-만들기"><a href="#_1-eks에-https-수신-컨트롤러-만들기" class="header-anchor">#</a> 1. EKS에 HTTPS 수신 컨트롤러 만들기</h4> <p>수신 컨트롤러는 역방향 프록시, 구성 가능한 트래픽 라우팅, Kubernetes 서비스에 대한 TLS 종료를 제공하는 소프트웨어이다. Kubernetes 수신 리소스는 개별 Kubernetes 서비스에 대한 수신 규칙 및 라우팅을 구성하는 데 사용된. 수신 컨트롤러 및 수신 규칙을 사용하면 단일 IP 주소를 사용하여 Kubernetes 클러스터의 여러 서비스에 트래픽을 라우팅할 수 있다.</p> <h5 id="_1-nginx-ingress-controller-설치"><a href="#_1-nginx-ingress-controller-설치" class="header-anchor">#</a> 1) nginx ingress controller 설치</h5> <div class="language- line-numbers-mode"><pre class="language-text"><code># namespace 생성
kubectl create ns dp3-ingress-basic

# Helm repo add
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

# Helm으로 Nginx Ingress Controller 설치
helm install dp3-nginx-ingress ingress-nginx/ingress-nginx \
    --namespace dp3-ingress-basic \
    --set controller.replicaCount=2 \
    --set controller.nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux \
    --set defaultBackend.nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux \
    --set controller.admissionWebhooks.patch.nodeSelector.&quot;beta\.kubernetes\.io/os&quot;=linux
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="_2-route-53-호스팅-영역에-record-추가하기"><a href="#_2-route-53-호스팅-영역에-record-추가하기" class="header-anchor">#</a> 2) Route 53 호스팅 영역에 Record 추가하기</h5> <p><img src="/am-arch/assets/img/harbor-route53.dd302a68.png" alt="Route53"></p> <h5 id="_3-cert-manager-설치하기"><a href="#_3-cert-manager-설치하기" class="header-anchor">#</a> 3) cert-manager 설치하기</h5> <p>Cert-manager 는 k8s 클러스터 내에서 TLS(구 SSL)_인증서를 자동으로 프로비저닝 및 관리_하는 오픈소스이다.</p> <p>Cert-manager는<a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer">let’s encrypt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,<a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Vault<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>같은 것을들 사용하여 인증서 발급을 할 수 있다. 인증서 발급후에도 만료가 되기 전 자동갱신을 한다.</p> <p><img src="/am-arch/assets/img/harbor-certmanager.666834d4.png" alt="cert-manager"><br>
(출처: https://cert-manager.io/docs/)</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># Label the ingress-basic namespace to disable resource validation
kubectl label ns dp3-ingress-basic cert-manager.io/disable-validation=true

# Add the Jetstack Helm repository
helm repo add jetstack https://charts.jetstack.io

# Update your local Helm chart repository cache
helm repo update

# Install the cert-manager Helm chart
helm install dp3-cert-manager jetstack/cert-manager \
  --namespace dp3-ingress-basic \
  --set installCRDs=true \
  --set nodeSelector.&quot;kubernetes\.io/os&quot;=linux \
  --set webhook.nodeSelector.&quot;kubernetes\.io/os&quot;=linux \
  --set cainjector.nodeSelector.&quot;kubernetes\.io/os&quot;=linux
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h5 id="_4-cluster-issuer-생성"><a href="#_4-cluster-issuer-생성" class="header-anchor">#</a> 4) Cluster Issuer 생성</h5> <p>Let's Encrypt는 보안 웹사이트를 위한 인증서의 수동 생성, 유효성 확인, 디지털 서명, 설치, 갱신 등 종전의 복잡한 과정을 없애주는 자동화된 프로세스를 통해 전송 계층 보안 암호화를 위해 무료 X.509 인증서를 제공하는 인증 기관이다.</p> <p><em>= 무료 SSL 인증서 자동 생성</em></p> <p>Let's Encrypt에서 인증서를 생성할 수 있도록cert-manager에서 사용하는 ClusterIssuer를 생성한다.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: MY_EMAIL_ADDRESS
    privateKeySecretRef:
      name: letsencrypt
    solvers:
    - http01:
        ingress:
          class: nginx
          podTemplate:
            spec:
              nodeSelector:
                &quot;kubernetes.io/os&quot;: linux
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Cluster Issuer를 apply한 후 ingress 리소스를 생성하면 spec 하위에 아래와 같은 내용이 생겨있다.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  tls:
  - hosts:
    - [YOUR_DOMAIN]
    secretName: tls-secret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>이 부분을 적절히 설정하면 아래와 같은 처리가 진행된다.</p> <ul><li>spec.tls.hosts에 설정한 도메인에 대한 검증을 진행한다. 검증에 필요한 웹 서버를 실행하고, 라우팅 설정을 업데이트한다.</li> <li>인증서가 발행되면spec.tls.secretName에서 지정한<a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreferrer">secret<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>에 저장한다. secret이 존재하지 않으면, 새로 만들고 저장한다.</li></ul> <p>인증서 발급이 정상적으로 완료되면, 아래와 같이 Ready = True 상태인 certificate를 조회할 수 있다.</p> <p><img src="/am-arch/assets/img/harbor-certificate.b8f73613.png" alt="certificate"></p> <p>이렇게 Ingress 가 생성될 때마다 자동으로 SSL 인증서를 생성할 준비가 완료되었다.</p> <h5 id="별첨"><a href="#별첨" class="header-anchor">#</a> +) 별첨</h5> <ol><li>kubed</li></ol> <p>다른 namespace에서 저번에 만들어둔 인증서를 사용하고 싶다면 어떻게 할까?</p> <p>kubed 는 cluster나 namespace 간에 configmaps/secrets를 동기화하는 기능을 한다.</p> <p><img src="/am-arch/assets/img/harbor-kubed2.d4486d0b.png" alt="kubed"><br>
(출처: https://cert-manager.io/docs/)</p> <p>Helm으로 kubed 설치</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>helm repo add appscode https://charts.appscode.com/stable/
helm install dp3-kubed appscode/kubed --namespace dp3-ingress-basic \
  --set config.clusterName=htdp1-cluster-001 \
  --set apiserver.enabled=false
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/am-arch/assets/img/harbor-helminstall.bdcc7190.png" alt="helm"></p> <p>그리고 harbor를 설치할 ns와 secret을 공유하기위해 현재 ns에 라벨링을 해준다. (나는 &quot;app=dp3&quot;이라는 라벨을 걸어주었다.)</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>kubectl label ns dp3-ingress-basic app=dp3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/am-arch/assets/img/harbor-label.e97e1828.png" alt="harbor label"></p> <p>다른 ns와 공유할 secret을 annotate 해준다.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>kubectl annotate secret tls-secret -n dp3-ingress-basic kubed.appscode.com/sync=&quot;app=dp3&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/am-arch/assets/img/harbor-annotate.71259ecb.png" alt="secret"></p> <hr> <h3 id="_2-harbor-설치"><a href="#_2-harbor-설치" class="header-anchor">#</a> 2. Harbor 설치</h3> <p>Helm으로 harbor 설치</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>helm repo add harbor https://helm.goharbor.io
helm install dp3-harbor -n dp3-harbor harbor/harbor \
  --set expose.ingress.hosts.core=harbor.htdp1.kubepia.net \
  --set persistence.enabled=true \
  --set externalURL=https://harbor.htdp1.kubepia.net
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>생성된 리소스 확인</p> <p><img src="/am-arch/assets/img/harbor-helmresource.5cb60f2d.png" alt="helm resource"></p> <p>chartmuseum,notary, trivy 등 3rd party들도 같이 설치되었다. 각 구성요소의 기능은 아래와 같다.</p> <p>- notary : docker image 서명 관리 도구<br>
- redis : 데이터 캐싱, 작업 메타 데이터 캐시<br>
- postgresql : 백엔드 스토리지 데이터 저장<br>
- Clair : 컨테이너 취약점 분석<br>
- trivy : 컨테이너 취약점 분석<br>
- jobservice : 백그라운드 작업을 대기열에 넣고 처리할 수 있는 <a href="https://github.com/gocraft/work" target="_blank" rel="noopener noreferrer">작업<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 을 기반으로 image replication에 사용됨<br>
- chartmuseum: helm chart 저장소</p> <p>ingress에서 host를 수정해주고 브라우저에서 harbor.htdp1.kubepia.net으로 접속한다.</p> <p><img src="/am-arch/assets/img/harbor-home.eee3717b.png" alt="harbor main"></p> <hr> <h3 id="_3-keyclock-oidc-연동-및-권한제어"><a href="#_3-keyclock-oidc-연동-및-권한제어" class="header-anchor">#</a> 3. keyclock OIDC 연동 및 권한제어</h3> <h4 id="_1-keycloak에-client-추가"><a href="#_1-keycloak에-client-추가" class="header-anchor">#</a> 1. Keycloak에 Client 추가</h4> <p>htdp1 Realm에 Client를 생성한다.</p> <p><img src="/am-arch/assets/img/harbor-realm.929dd58d.png" alt="realm"></p> <p>Root URL에 Keycloak과 연동할 도메인을 입력해주고 Save한다.</p> <p>다음은 Settings 진입</p> <p><img src="/am-arch/assets/img/harbor-keycloaksetting.44e643d0.png" alt="keycloak setting"></p> <p><img src="/am-arch/assets/img/harbor-settingdetail.27e98b33.png" alt="setting detail"></p> <p>Client Setting에서 Access Type = confidential로 설정후 Credentials 탭으로 이동해보면,</p> <p><img src="/am-arch/assets/img/harbor-keycredentials.1df92309.png" alt="credentials"></p> <p>위와같이 Secret uuid가 생성된 것을 볼 수 있다!</p> <p>이 Client Id 와 Secret으로 연동을 진행할 것이다</p> <h4 id="_2-harbor-configuration"><a href="#_2-harbor-configuration" class="header-anchor">#</a> 2. Harbor Configuration</h4> <p>Harbor 관리자 계정으로 접속 후, 왼쪽 메뉴에서 Configuration을 선택한다.</p> <p>여기서 auth mode=OIDC, provider=keycloak, endpoint= keycloak 도메인을 입력해주고</p> <p>아까 keycloak 에서 확인한 client id 와 secret을 입력한다.</p> <p><img src="/am-arch/assets/img/harbor-configuration.337d868d.png" alt="configuration"></p> <p><img src="/am-arch/assets/img/harbor-oidc.32842c10.png" alt="oidc verified"></p> <p><img src="/am-arch/assets/img/harbor-mainoidc.36879677.png" alt="harbor main oidc"></p> <p><strong>LOGIN VIA OIDC PROVIDER</strong>버튼이 생성되었다. 이제 Keycloak 계정을 통해 Harbor에 접속할 수 있다.</p> <p>이제는 keycloak 계정을 통한 user 별 (또는 group 별) 권한제어를 위해,</p> <p><strong>keycloak에 생성한 user</strong>를 harbor UI 를 통해서<strong>제어</strong>할 수 있는지 확인하고, CLI로 로그인 및 docker event도 테스트해볼 것이다.</p> <p>일단 harbor에 연동해둔 keycloak의 Realm으로 진입후 Users 메뉴를 선택후 Add user 버튼을 누른다.</p> <p><img src="/am-arch/assets/img/harbor-user.3ef78350.png" alt="keycloack user"></p> <p>적당히 만들어준다. Save 버튼을 눌러 user를 생성한 후 , Credentials 탭으로 진입한다.</p> <p><img src="/am-arch/assets/img/harbor-keyuser.0728c737.png" alt="keyclock user credential"></p> <p>password / confirmation을 입력하고 &quot;Set Password&quot; 버튼을 누른다. 다음은 Role Mappings 탭에 진입한다.</p> <p><img src="/am-arch/assets/img/harbor-rolemappings.73b5f8a3.png" alt="role mappings"></p> <p>Client Roles 콤보박스에서 harbor에 연결했던 client를 선택하고, Role을 Mapping해 준다.</p> <p>이제 적당히 User가 생성되었으므로, Harbor Web UI에서 &quot;Login via OIDC Provider&quot; 버튼을 눌러 로그인한다.</p> <p><img src="/am-arch/assets/img/harbor-login.88a57a6d.png" alt="harbor login"></p> <p>password를 변경해 주고 나면 OIDC username을 입력하는 창이 뜨고</p> <p><img src="/am-arch/assets/img/harbor-username.783b9b8c.png" alt="set username"></p> <p>이거까지 입력해주고 나면 harbor에 로그인이 된다. 이후에 admin 계정으로 들어가 보면, users에 방금 생성한 계정이 생겨있다.</p> <p><img src="/am-arch/assets/img/harbor-users.84e887a6.png" alt="harbor users"></p> <p>이제 해당 user로 CLI command를 날려볼 것이다.</p> <p>다시 아까 생성한 user로 접속해 오른쪽 상단의 OIDC username을 클릭해 User profile로 들어간다.</p> <p><img src="/am-arch/assets/img/harbor-userprofile.d6c3d95f.png" alt="user profile"></p> <p><img src="/am-arch/assets/img/harbor-userprofiledetail.58d4f302.png" alt="user profile detail"></p> <p>CLI secret을 복사해 두고, docker login [YOUR_DOMAIN]을 시도한다.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker login harbor2.htdp1.kubepia.net
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>harbor에서 설정한 OIDC username과 CLI secret으로 로그인하자.</p> <p><img src="/am-arch/assets/img/harbor-dockerlogin.dd06cf04.png" alt="docker login"></p> <hr> <h3 id="_4-registry-replication"><a href="#_4-registry-replication" class="header-anchor">#</a> 4. Registry Replication</h3> <h4 id="_1-이중화-구성하기"><a href="#_1-이중화-구성하기" class="header-anchor">#</a> 1. 이중화  구성하기</h4> <p>Harbor에서 공식적으로 지원하는 기능 중 &quot; Configuring Replication &quot; 이 있다.</p> <p>이는 여러 Registry 간에 resource ( image, chart 등 ) 들을 동기화 하는 기능을 한다.</p> <p>Harbour 시스템 관리자가 Replication Rule 을 설정한 경우 트리거 조건이 충족되면 정의된 필터 패턴과 일치하는 모든 리소스가 대상 레지스트리에 복제된다.</p> <p>cf) 그런데 실제 운영환경에서 수십 또는 수백 개의 클러스터 노드를 릴리스하기 위해 미러링해야 하는 경우가 많다.이 경우 단일 다운로드 레지스트리는 많은 노드의 요구를 충족할 수 없으므로 로드 밸런싱을 수행하도록 여러 인스턴스 레지스트리를 구성한다.</p> <p><img src="/am-arch/assets/img/harbor-hahabor.7a01c0e9.png" alt="harbor ha"></p> <p>harbor 에서는 위와 같이 다양한 Registry들의 Replication을 지원하고 있다.</p> <p>미리 harbor Registry를 하나 더 구성해 두고 (harbor2), harbor2에서 기존 harbor의 endpoint를 등록해보았다</p> <p><img src="/am-arch/assets/img/harbor-endpoint.8024094a.png" alt="harbor endpoint"></p> <p>endpoint를 등록했다면 Replications 메뉴로 들어가 Rule을 생성해 본다.</p> <p><img src="/am-arch/assets/img/harbor-endpointrule.ab0767d2.png" alt="harbor endpoint rule"></p> <p>Destination registry ( 데이터를 동기화할 Registry )에 방금 등록한 endpoint가 뜨는 것을 볼 수 있다.</p> <p>push-based와 pull-based는 artifact를 복제할때 다른 registry로부터 복제받을 것인지 혹은 다른 registry로 복제할 것인지를 결정한다. ( 공식 Harbor docs: Select<strong>Push-based</strong>or<strong>Pull-based</strong>replication, depending on whether you want to replicate artifacts to or from the remote registry. )</p> <p>이렇게 등록해놓고 나면 아래처럼 harbor2에 image가 push 될 때 마다 기존 harbor와 데이터가 동기화 된다.</p> <p><img src="/am-arch/assets/img/harbor-dockerpush.ca3bfe1e.png" alt="docker push"></p> <p>harbor2에 image push</p> <p><img src="/am-arch/assets/img/harbor-sync.d4b6a0f3.png" alt="sync"></p> <p>기존 harbor에도 kmchoi-test가 Push되었다.</p> <p>그런데 harbor2에 기존 harbor Registry를 등록하는 것은 harbor2-&gt;harbor 로의 단방향 동기화만을 의미하기 때문에,</p> <p>양방향 동기화를 원한다면 harbor에서도 harbor2 Registry와 Rule을 생성해주어야 한다.</p> <hr> <h3 id="_5-vulnerability-scanning"><a href="#_5-vulnerability-scanning" class="header-anchor">#</a> 5. Vulnerability Scanning</h3> <p>Projects &gt; Repo 진입</p> <p>Artifacts 탭에서 원하는 이미지를 선택 후 SCAN 버튼 클릭</p> <p><img src="/am-arch/assets/img/harbor-scanning.64576def.png" alt="harbor scanning"></p> <p>scan 이 완료되고 artifact 를 눌러보면 다음과 같이 스캔 결과를 확인할 수 있다.</p> <p><img src="/am-arch/assets/img/harbor-vulnerabilities.41e65a30.png" alt="vulnerabilities"></p> <p>Vulnerabilities 위에 마우스를 올려보면 취약성 통계결과도 확인할 수 있다.</p> <p><img src="/am-arch/assets/img/harbor-vulseverity.5e03b84a.png" alt="vul severity"></p> <hr></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/am-arch/refarch/keycloak.html" class="prev">
        2조 소과제: Keycloak
      </a></span> <!----></p></div> </main></div></div><div class="global-ui"></div></div>
    <script src="/am-arch/assets/js/app.1912b913.js" defer></script><script src="/am-arch/assets/js/2.24fdfc9c.js" defer></script><script src="/am-arch/assets/js/3.0b98036c.js" defer></script>
  </body>
</html>
